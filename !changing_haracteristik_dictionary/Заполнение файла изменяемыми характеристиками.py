import pandas as pd
import json

# –ó–∞–≥—Ä—É–∂–∞–µ–º Excel
df = pd.read_excel(r"C:\Users\m.olshanskiy\Desktop\10-11.2025_—Ä—ã–Ω–æ–∫.xlsx")

# –ó–∞–≥—Ä—É–∂–∞–µ–º JSON
with open("projects_old.json", "r", encoding="utf-8") as f:
    data = json.load(f)

# –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–ª–æ–Ω–∫–∏, –µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç
required_columns = [
    "–°—Ä–æ–∫ —Å–¥–∞—á–∏",
    "–°—Ç–∞–¥–∏—è —Å—Ç—Ä–æ–∏—Ç–µ–ª—å–Ω–æ–π –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏",
    "–î–æ–≥–æ–≤–æ—Ä",
    "–°—Ç–∞—Ç—É—Å",
    "–†–∞—Å–ø—Ä–æ–¥–∞–Ω–Ω–æ—Å—Ç—å –∫–≤–∞—Ä—Ç–∏—Ä",
    "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–≤–∞—Ä—Ç–∏—Ä",
    "–ñ–∏–ª–∞—è –ø–ª–æ—â–∞–¥—å, –º¬≤"
]

for col in required_columns:
    if col not in df.columns:
        df[col] = None

# —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
rows_updated = 0
rows_skipped = 0

# –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ—Ä–ø—É—Å–∞
df['–ö–æ—Ä–ø—É—Å'] = df['–ö–æ—Ä–ø—É—Å'].astype(str)
df['–ö–æ—Ä–ø—É—Å'] = df['–ö–æ—Ä–ø—É—Å'].str.replace(',', '.', regex=False)

# –ó–∞–ø–æ–ª–Ω—è–µ–º –∑–Ω–∞—á–µ–Ω–∏—è
for idx, row in df.iterrows():
    project_key = f"{row['–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞']}_{row['–î–µ–≤–µ–ª–æ–ø–µ—Ä']}"
    corpus = str(row['–ö–æ—Ä–ø—É—Å'])

    if project_key in data and corpus in data[project_key]:

        record = data[project_key][corpus]

        df.at[idx, "–°—Ä–æ–∫ —Å–¥–∞—á–∏"] = record.get("–°—Ä–æ–∫ —Å–¥–∞—á–∏")
        df.at[idx, "–°—Ç–∞–¥–∏—è —Å—Ç—Ä–æ–∏—Ç–µ–ª—å–Ω–æ–π –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏"] = record.get("–°—Ç–∞–¥–∏—è —Å—Ç—Ä–æ–∏—Ç–µ–ª—å–Ω–æ–π –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏")
        df.at[idx, "–î–æ–≥–æ–≤–æ—Ä"] = record.get("–î–æ–≥–æ–≤–æ—Ä")
        df.at[idx, "–°—Ç–∞—Ç—É—Å"] = record.get("–°—Ç–∞—Ç—É—Å")
        df.at[idx, "–†–∞—Å–ø—Ä–æ–¥–∞–Ω–Ω–æ—Å—Ç—å –∫–≤–∞—Ä—Ç–∏—Ä"] = record.get("–†–∞—Å–ø—Ä–æ–¥–∞–Ω–Ω–æ—Å—Ç—å –∫–≤–∞—Ä—Ç–∏—Ä")
        df.at[idx, "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–≤–∞—Ä—Ç–∏—Ä"] = record.get("–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–≤–∞—Ä—Ç–∏—Ä")
        df.at[idx, "–ñ–∏–ª–∞—è –ø–ª–æ—â–∞–¥—å, –º¬≤"] = record.get("–ñ–∏–ª–∞—è –ø–ª–æ—â–∞–¥—å, –º¬≤")

        rows_updated += 1
    else:
        rows_skipped += 1

df["–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–≤–∞—Ä—Ç–∏—Ä"] = (
    df["–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–≤–∞—Ä—Ç–∏—Ä"]
    .astype(str)
    .str.replace(r"[^\d\.]", "", regex=True)  # —É–±–∏—Ä–∞–µ–º –≤—Å—ë –ª–∏—à–Ω–µ–µ
    .replace("", None)
    .astype(float)
    .astype("Int64")  # —Ü–µ–ª–æ–µ —á–∏—Å–ª–æ –±–µ–∑ .0 (–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç NaN)
)

# –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º "–ñ–∏–ª–∞—è –ø–ª–æ—â–∞–¥—å, –º¬≤"
df["–ñ–∏–ª–∞—è –ø–ª–æ—â–∞–¥—å, –º¬≤"] = (
    df["–ñ–∏–ª–∞—è –ø–ª–æ—â–∞–¥—å, –º¬≤"]
    .astype(str)
    .str.replace(r"[^\d\.]", "", regex=True)
    .replace("", None)
    .astype(float)
    .astype("Int64")
)

# —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
df.to_excel(r"C:\Users\m.olshanskiy\Desktop\10-11.2025_—Ä—ã–Ω–æ–∫_new.xlsx", index=False)

# –≤—ã–≤–æ–¥–∏–º –ª–æ–≥–∏
print("=== üî• –õ–û–ì–ò üî• ===")
print(f"–í—Å–µ–≥–æ —Å—Ç—Ä–æ–∫: {len(df)}")
print(f"–û–±–Ω–æ–≤–ª–µ–Ω–æ —Å—Ç—Ä–æ–∫: {rows_updated}")
print(f"–ü—Ä–æ–ø—É—â–µ–Ω–æ —Å—Ç—Ä–æ–∫ (–Ω–µ—Ç –≤ JSON): {rows_skipped}")
print("‚úÖ –§–∞–π–ª —Å–æ—Ö—Ä–∞–Ω—ë–Ω")